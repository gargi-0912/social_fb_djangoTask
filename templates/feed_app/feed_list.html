{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Social Feed Module</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .feed-container { max-width: 650px; margin: 0 auto; }
        .feed-card { 
            background-color: #ffffff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24); 
            margin-bottom: 20px; padding: 20px; 
        }
        .feed-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .user-info { font-weight: 600; color: #050505; }
        .timestamp { font-size: 12px; color: #606770; margin-left: 10px; }
        .report-btn { color: #606770; cursor: pointer; font-size: 14px; padding: 5px 10px; border: none; background: none; }
        
        .image-grid { display: grid; gap: 5px; margin-top: 10px; }
        .image-grid img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; display: block; }
        .img-item { overflow: hidden; height: 250px; } 
        .image-grid[data-count="1"] { grid-template-columns: 1fr; }
        .image-grid[data-count="2"] { grid-template-columns: repeat(2, 1fr); }
        .image-grid[data-count="3"] { grid-template-columns: 2fr 1fr; }
        .image-grid[data-count="3"] .img-item:first-child { 
            grid-row: 1 / 3; 
            height: 505px;
        }
        .image-grid[data-count="4"] { grid-template-columns: repeat(2, 1fr); }

        .comment-section { border-top: 1px solid #eee; padding-top: 15px; }
        .comment-item { margin-bottom: 8px; padding: 5px; background: #f7f7f7; border-radius: 4px; }
        .add-comment input { width: 75%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 5px; }
        .add-comment button { padding: 8px 15px; background-color: #1877f2; color: white; border: none; border-radius: 4px; cursor: pointer; }

        .loading-message { text-align: center; color: #606770; padding: 20px; }
        .post-form-btn { width: 100%; background-color: #42b72a; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer; }

        /* Preview images in upload area */
        .preview-image { width: 150px; height: 150px; object-fit: cover; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="feed-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 style="color: #1877f2;">Social Feed</h1>
            <div>
                <span style="margin-right: 15px;">Logged in as: <strong>{{ current_username }}</strong></span>
                <a href="{% url 'logout' %}" style="text-decoration: none; color: white; background-color: #fa383e; padding: 8px 15px; border-radius: 4px;">Log Out</a>
            </div>
        </div>
        
        <div class="feed-card create-post-card">
            <h2>Create New Post</h2>
            <textarea id="post-text" placeholder="What's happening?" rows="3" style="width: 100%; border: 1px solid #ddd; padding: 10px; border-radius: 4px; margin-bottom: 10px;"></textarea>
            
            <input type="file" id="image-upload" accept="image/*" multiple style="margin-bottom: 10px;">
            <div id="image-crop-area" style="display: flex; flex-wrap: wrap;"></div>
            
            <button id="post-submit" onclick="submitFeed()" class="post-form-btn" disabled>Post</button>
        </div>
        
        <div id="feed-listing"></div>
        
        <div class="loading-message" id="loading-spinner">Loading more feeds...</div>
        <div class="loading-message" id="end-of-feed" style="display: none;">You've reached the end!</div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        const CSRF_TOKEN = '{{ csrf_token }}'; 
        const API_BASE_URL = "/api/v1/feeds"; 
        let currentOffset = 0;
        const limit = 10; 
        let isLoading = false;
        let imageFiles = []; 

        // --- Helper Functions ---
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function formatTimestamp(isoString) {
            const date = new Date(isoString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        function renderFeedCard(feed) {
            const imageCount = feed.images.length;
            let imageHtml = '';
            
            if (imageCount > 0) {
                imageHtml = `<div class="image-grid" data-count="${imageCount}">`;
                // feed.images.forEach((img) => {
                //     imageHtml += `<div class="img-item"><img src="${img.image_url}" alt="Post image"></div>`;
                // });
                feed.images.forEach((img) => {

                    imageHtml += `<div class="img-item"><img src="${img.image}" alt="Post image"></div>`;
                });

                imageHtml += `</div>`;
            }

            let commentsHtml = `<div class="comment-section" id="comments-${feed.id}">`;
            feed.comments.forEach((comment) => {
                commentsHtml += `
                    <p class="comment-item">
                        <strong>${comment.user.username}</strong>: ${comment.text_content}
                        <span class="timestamp">(${formatTimestamp(comment.created_at)})</span>
                    </p>
                `;
            });

            commentsHtml += `
                <div class="add-comment">
                    <input type="text" id="comment-input-${feed.id}" placeholder="Write a comment...">
                    <button onclick="postComment(${feed.id})">Comment</button>
                </div>
            </div>`;

            const feedCard = `
                <div class="feed-card" id="feed-${feed.id}">
                    <div class="feed-header">
                        <span class="user-info">${feed.user.username}</span>
                        <div>
                            <span class="timestamp">${formatTimestamp(feed.created_at)}</span>
                            <button class="report-btn" onclick="reportFeed(${feed.id})">Report</button> 
                        </div>
                    </div>
                    
                    <div class="feed-content">
                        ${feed.text_content}
                        ${imageHtml} 
                    </div>
                    ${commentsHtml} 
                </div>
            `;
            $('#feed-listing').prepend(feedCard);
        }

        async function fetchFeeds() {
            if (isLoading) return;
            isLoading = true;
            $('#loading-spinner').show();
            try {
                const response = await fetch(`${API_BASE_URL}?offset=${currentOffset}&limit=${limit}`);
                if (response.status === 401) { window.location.href = '/login/'; return; }
                if (!response.ok) throw new Error('Failed to fetch feeds.');
                const feeds = await response.json();
                if (feeds.length === 0) { $('#end-of-feed').show(); $(window).off('scroll'); } 
                else { feeds.forEach(renderFeedCard); currentOffset += feeds.length; }
            } catch (error) { console.error("Feed fetch error:", error); } 
            finally { isLoading = false; $('#loading-spinner').hide(); }
        }

        async function postComment(feedId) {
            const input = $(`#comment-input-${feedId}`);
            const text_content = input.val().trim();
            if (!text_content) return;
            try {
                const response = await fetch(`${API_BASE_URL}/${feedId}/comments/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                    body: JSON.stringify({ text_content: text_content })
                });
                if (response.ok) {
                    const comment = await response.json();
                    const commentHtml = `<p class="comment-item"><strong>${comment.user.username}</strong>: ${comment.text_content} <span class="timestamp">(${formatTimestamp(comment.created_at)})</span></p>`;
                    $(`#comments-${feedId} .add-comment`).before(commentHtml);
                    input.val('');
                } else { const data = await response.json(); alert(`Comment failed: ${data.detail}`); }
            } catch (error) { alert("An error occurred while commenting."); }
        }

        // async function reportFeed(feedId) {
        //     if (!confirm("Are you sure you want to report this post?")) return;

        //     try {
        //         const response = await fetch(`${API_BASE_URL}/${feedId}/report/`, {
        //             method: 'POST',
        //             headers: {
        //                 'Content-Type': 'application/json',
        //                 'X-CSRFToken': getCookie('csrftoken')
        //             }
        //         });

        //         if (response.ok) {
        //             alert("Feed reported successfully!");
        //             // Optionally disable the report button
        //             $(`#feed-${feedId} .report-btn`)
        //                 .text("Reported")
        //                 .prop("disabled", true)
        //                 .css({ color: "gray", cursor: "not-allowed" });
        //         } else {
        //             const data = await response.json();
        //             alert(`Failed to report feed: ${data.detail || 'Unknown error'}`);
        //         }
        //     } catch (error) {
        //         console.error("Report feed error:", error);
        //         alert("An error occurred while reporting the feed.");
        //     }
        // }

        async function reportFeed(feedId) {
            if (!confirm("Are you sure you want to report this post?")) return;

            try {
                const response = await fetch(`${API_BASE_URL}/${feedId}/report/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie("csrftoken"),
                    },
                });

                const data = await response.json();

                if (response.ok) {
                    alert(data.detail || "Feed reported successfully!");

                    // Optionally disable the report button to prevent multiple reports
                    const btn = document.querySelector(`#feed-${feedId} .report-btn`);
                    if (btn) {
                        btn.textContent = "Reported";
                        btn.disabled = true;
                        btn.style.color = "gray";
                        btn.style.cursor = "not-allowed";
                    }
                } else {
                    alert(data.detail || "Error while reporting feed.");
                }
            } catch (error) {
                console.error("Report error:", error);
                alert("Something went wrong while reporting this feed.");
            }
        }


        // async function submitFeed() {
        //     const text_content = $('#post-text').val().trim();
        //     const image_urls = imageFiles.map((f,i) => `uploaded_image_${i + 1}_${Math.random().toString(36).substring(2)}.jpg`);
        //     if (!text_content && image_urls.length === 0) { alert("Post cannot be empty."); return; }
        //     try {
        //         const response = await fetch(API_BASE_URL + '/', {
        //             method: 'POST',
        //             headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        //             body: JSON.stringify({ text_content, image_urls })
        //         });
        //         if (response.ok) {
        //             const newFeed = await response.json();
        //             renderFeedCard(newFeed);
        //             $('#post-text').val('');
        //             $('#image-crop-area').html('');
        //             $('#image-upload').val('');
        //             imageFiles = [];
        //             $('#post-submit').prop('disabled', true);
        //             alert("Feed created successfully!");
        //         } else { const data = await response.json(); alert("Feed creation failed: " + JSON.stringify(data)); }
        //     } catch (error) { console.error(error); alert("An error occurred during post submission."); }
        // }

        async function submitFeed() {
            const text_content = $('#post-text').val().trim();
            if (!text_content && imageFiles.length === 0) {
                alert("Post cannot be empty."); 
                return; 
            }

            const formData = new FormData();
            formData.append('text_content', text_content);

            imageFiles.forEach((file, idx) => {
                formData.append('images', file); // backend expects 'images' list
            });

            try {
                const response = await fetch(API_BASE_URL + '/', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCookie('csrftoken') }, // NO Content-Type header, let browser handle
                    body: formData
                });

                if (response.ok) {
                    const newFeed = await response.json();
                    renderFeedCard(newFeed);
                    $('#post-text').val('');
                    $('#image-crop-area').html('');
                    $('#image-upload').val('');
                    imageFiles = [];
                    $('#post-submit').prop('disabled', true);
                    alert("Feed created successfully!");
                } else {
                    const data = await response.json();
                    alert("Feed creation failed: " + JSON.stringify(data));
                }
            } catch (error) {
                console.error(error);
                alert("An error occurred during post submission.");
            }
        }


        // --- IMAGE PREVIEW LOGIC ---
        $('#image-upload').on('change', function(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;

            $('#image-crop-area').html(''); 
            imageFiles = [];
            const maxFiles = Math.min(files.length, 4);

            for (let i = 0; i < maxFiles; i++) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.classList.add('preview-image');
                    $('#image-crop-area').append(img);
                    imageFiles[i] = files[i];
                    if ($('#post-text').val().trim().length > 0 || imageFiles.length > 0) $('#post-submit').prop('disabled', false);
                }
                reader.readAsDataURL(files[i]);
            }
        });

        $('#post-text').on('input', function() {
            if ($(this).val().trim().length > 0 || imageFiles.length > 0) $('#post-submit').prop('disabled', false);
            else $('#post-submit').prop('disabled', true);
        });

        function checkScroll() {
            if ($(window).scrollTop() + $(window).height() >= $(document).height() - 100) fetchFeeds(); 
        }

        $(document).ready(function() {
            fetchFeeds();
            $(window).on('scroll', checkScroll);
        });

    </script>
</body>
</html>
