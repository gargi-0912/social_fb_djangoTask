<!-- {% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Social Feed Module</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .feed-container { max-width: 650px; margin: 0 auto; }
        .feed-card { 
            background-color: #ffffff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24); 
            margin-bottom: 20px; padding: 20px; 
        }
        .feed-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .user-info { font-weight: 600; color: #050505; }
        .timestamp { font-size: 12px; color: #606770; margin-left: 10px; }
        .report-btn { color: #606770; cursor: pointer; font-size: 14px; padding: 5px 10px; border: none; background: none; }
        
        .image-grid { display: grid; gap: 5px; margin-top: 10px; }
        .image-grid img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; display: block; }
        .img-item { overflow: hidden; height: 250px; } 
        .image-grid[data-count="1"] { grid-template-columns: 1fr; }
        .image-grid[data-count="2"] { grid-template-columns: repeat(2, 1fr); }
        .image-grid[data-count="3"] { grid-template-columns: 2fr 1fr; }
        .image-grid[data-count="3"] .img-item:first-child { 
            grid-row: 1 / 3; 
            height: 505px;
        }
        .image-grid[data-count="4"] { grid-template-columns: repeat(2, 1fr); }

        .comment-section { border-top: 1px solid #eee; padding-top: 15px; }
        .comment-item { margin-bottom: 8px; padding: 5px; background: #f7f7f7; border-radius: 4px; }
        .add-comment input { width: 75%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 5px; }
        .add-comment button { padding: 8px 15px; background-color: #1877f2; color: white; border: none; border-radius: 4px; cursor: pointer; }

        .loading-message { text-align: center; color: #606770; padding: 20px; }
        .post-form-btn { width: 100%; background-color: #42b72a; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer; }

        /* Preview images in upload area */
        .preview-image { width: 150px; height: 150px; object-fit: cover; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="feed-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 style="color: #1877f2;">Social Feed</h1>
            <div>
                <span style="margin-right: 15px;">Logged in as: <strong>{{ current_username }}</strong></span>
                <a href="{% url 'logout' %}" style="text-decoration: none; color: white; background-color: #fa383e; padding: 8px 15px; border-radius: 4px;">Log Out</a>
            </div>
        </div>
        
        <div class="feed-card create-post-card">
            <h2>Create New Post</h2>
            <textarea id="post-text" placeholder="What's happening?" rows="3" style="width: 100%; border: 1px solid #ddd; padding: 10px; border-radius: 4px; margin-bottom: 10px;"></textarea>
            
            <input type="file" id="image-upload" accept="image/*" multiple style="margin-bottom: 10px;">
            <div id="image-crop-area" style="display: flex; flex-wrap: wrap;"></div>
            
            <button id="post-submit" onclick="submitFeed()" class="post-form-btn" disabled>Post</button>
        </div>
        
        <div id="feed-listing"></div>
        
        <div class="loading-message" id="loading-spinner">Loading more feeds...</div>
        <div class="loading-message" id="end-of-feed" style="display: none;">You've reached the end!</div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        const CSRF_TOKEN = '{{ csrf_token }}'; 
        const API_BASE_URL = "/api/v1/feeds"; 
        let currentOffset = 0;
        const limit = 10; 
        let isLoading = false;
        let imageFiles = []; 

        // --- Helper Functions ---
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function formatTimestamp(isoString) {
            const date = new Date(isoString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        function renderFeedCard(feed) {
            const imageCount = feed.images.length;
            let imageHtml = '';
            
            if (imageCount > 0) {
                imageHtml = `<div class="image-grid" data-count="${imageCount}">`;
                // feed.images.forEach((img) => {
                //     imageHtml += `<div class="img-item"><img src="${img.image_url}" alt="Post image"></div>`;
                // });
                feed.images.forEach((img) => {

                    imageHtml += `<div class="img-item"><img src="${img.image}" alt="Post image"></div>`;
                });

                imageHtml += `</div>`;
            }

            let commentsHtml = `<div class="comment-section" id="comments-${feed.id}">`;
            feed.comments.forEach((comment) => {
                commentsHtml += `
                    <p class="comment-item">
                        <strong>${comment.user.username}</strong>: ${comment.text_content}
                        <span class="timestamp">(${formatTimestamp(comment.created_at)})</span>
                    </p>
                `;
            });

            commentsHtml += `
                <div class="add-comment">
                    <input type="text" id="comment-input-${feed.id}" placeholder="Write a comment...">
                    <button onclick="postComment(${feed.id})">Comment</button>
                </div>
            </div>`;

            const feedCard = `
                <div class="feed-card" id="feed-${feed.id}">
                    <div class="feed-header">
                        <span class="user-info">${feed.user.username}</span>
                        <div>
                            <span class="timestamp">${formatTimestamp(feed.created_at)}</span>
                            <button class="report-btn" onclick="reportFeed(${feed.id})">Report</button> 
                        </div>
                    </div>
                    
                    <div class="feed-content">
                        ${feed.text_content}
                        ${imageHtml} 
                    </div>
                    ${commentsHtml} 
                </div>
            `;
            $('#feed-listing').prepend(feedCard);
        }

        async function fetchFeeds() {
            if (isLoading) return;
            isLoading = true;
            $('#loading-spinner').show();
            try {
                const response = await fetch(`${API_BASE_URL}?offset=${currentOffset}&limit=${limit}`);
                if (response.status === 401) { window.location.href = '/login/'; return; }
                if (!response.ok) throw new Error('Failed to fetch feeds.');
                const feeds = await response.json();
                if (feeds.length === 0) { $('#end-of-feed').show(); $(window).off('scroll'); } 
                else { feeds.forEach(renderFeedCard); currentOffset += feeds.length; }
            } catch (error) { console.error("Feed fetch error:", error); } 
            finally { isLoading = false; $('#loading-spinner').hide(); }
        }

        async function postComment(feedId) {
            const input = $(`#comment-input-${feedId}`);
            const text_content = input.val().trim();
            if (!text_content) return;
            try {
                const response = await fetch(`${API_BASE_URL}/${feedId}/comments/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                    body: JSON.stringify({ text_content: text_content })
                });
                if (response.ok) {
                    const comment = await response.json();
                    const commentHtml = `<p class="comment-item"><strong>${comment.user.username}</strong>: ${comment.text_content} <span class="timestamp">(${formatTimestamp(comment.created_at)})</span></p>`;
                    $(`#comments-${feedId} .add-comment`).before(commentHtml);
                    input.val('');
                } else { const data = await response.json(); alert(`Comment failed: ${data.detail}`); }
            } catch (error) { alert("An error occurred while commenting."); }
        }

        // async function reportFeed(feedId) {
        //     if (!confirm("Are you sure you want to report this post?")) return;

        //     try {
        //         const response = await fetch(`${API_BASE_URL}/${feedId}/report/`, {
        //             method: 'POST',
        //             headers: {
        //                 'Content-Type': 'application/json',
        //                 'X-CSRFToken': getCookie('csrftoken')
        //             }
        //         });

        //         if (response.ok) {
        //             alert("Feed reported successfully!");
        //             // Optionally disable the report button
        //             $(`#feed-${feedId} .report-btn`)
        //                 .text("Reported")
        //                 .prop("disabled", true)
        //                 .css({ color: "gray", cursor: "not-allowed" });
        //         } else {
        //             const data = await response.json();
        //             alert(`Failed to report feed: ${data.detail || 'Unknown error'}`);
        //         }
        //     } catch (error) {
        //         console.error("Report feed error:", error);
        //         alert("An error occurred while reporting the feed.");
        //     }
        // }

        async function reportFeed(feedId) {
            if (!confirm("Are you sure you want to report this post?")) return;

            try {
                const response = await fetch(`${API_BASE_URL}/${feedId}/report/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie("csrftoken"),
                    },
                });

                const data = await response.json();

                if (response.ok) {
                    alert(data.detail || "Feed reported successfully!");

                    // Optionally disable the report button to prevent multiple reports
                    const btn = document.querySelector(`#feed-${feedId} .report-btn`);
                    if (btn) {
                        btn.textContent = "Reported";
                        btn.disabled = true;
                        btn.style.color = "gray";
                        btn.style.cursor = "not-allowed";
                    }
                } else {
                    alert(data.detail || "Error while reporting feed.");
                }
            } catch (error) {
                console.error("Report error:", error);
                alert("Something went wrong while reporting this feed.");
            }
        }


        // async function submitFeed() {
        //     const text_content = $('#post-text').val().trim();
        //     const image_urls = imageFiles.map((f,i) => `uploaded_image_${i + 1}_${Math.random().toString(36).substring(2)}.jpg`);
        //     if (!text_content && image_urls.length === 0) { alert("Post cannot be empty."); return; }
        //     try {
        //         const response = await fetch(API_BASE_URL + '/', {
        //             method: 'POST',
        //             headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        //             body: JSON.stringify({ text_content, image_urls })
        //         });
        //         if (response.ok) {
        //             const newFeed = await response.json();
        //             renderFeedCard(newFeed);
        //             $('#post-text').val('');
        //             $('#image-crop-area').html('');
        //             $('#image-upload').val('');
        //             imageFiles = [];
        //             $('#post-submit').prop('disabled', true);
        //             alert("Feed created successfully!");
        //         } else { const data = await response.json(); alert("Feed creation failed: " + JSON.stringify(data)); }
        //     } catch (error) { console.error(error); alert("An error occurred during post submission."); }
        // }

        async function submitFeed() {
            const text_content = $('#post-text').val().trim();
            if (!text_content && imageFiles.length === 0) {
                alert("Post cannot be empty."); 
                return; 
            }

            const formData = new FormData();
            formData.append('text_content', text_content);

            imageFiles.forEach((file, idx) => {
                formData.append('images', file); // backend expects 'images' list
            });

            try {
                const response = await fetch(API_BASE_URL + '/', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCookie('csrftoken') }, // NO Content-Type header, let browser handle
                    body: formData
                });

                if (response.ok) {
                    const newFeed = await response.json();
                    renderFeedCard(newFeed);
                    $('#post-text').val('');
                    $('#image-crop-area').html('');
                    $('#image-upload').val('');
                    imageFiles = [];
                    $('#post-submit').prop('disabled', true);
                    alert("Feed created successfully!");
                } else {
                    const data = await response.json();
                    alert("Feed creation failed: " + JSON.stringify(data));
                }
            } catch (error) {
                console.error(error);
                alert("An error occurred during post submission.");
            }
        }


        // --- IMAGE PREVIEW LOGIC ---
        $('#image-upload').on('change', function(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;

            $('#image-crop-area').html(''); 
            imageFiles = [];
            const maxFiles = Math.min(files.length, 4);

            for (let i = 0; i < maxFiles; i++) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.classList.add('preview-image');
                    $('#image-crop-area').append(img);
                    imageFiles[i] = files[i];
                    if ($('#post-text').val().trim().length > 0 || imageFiles.length > 0) $('#post-submit').prop('disabled', false);
                }
                reader.readAsDataURL(files[i]);
            }
        });

        $('#post-text').on('input', function() {
            if ($(this).val().trim().length > 0 || imageFiles.length > 0) $('#post-submit').prop('disabled', false);
            else $('#post-submit').prop('disabled', true);
        });

        function checkScroll() {
            if ($(window).scrollTop() + $(window).height() >= $(document).height() - 100) fetchFeeds(); 
        }

        $(document).ready(function() {
            fetchFeeds();
            $(window).on('scroll', checkScroll);
        });

    </script>
</body>
</html> -->


{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Social Feed</title>

  <style>
    :root {
      --primary: #1877f2;
      --secondary: #42b72a;
      --danger: #fa383e;
      --bg-light: #f0f2f5;
      --text-dark: #050505;
      --text-muted: #606770;
      --card-bg: #fff;
      --border: #e4e6eb;
      --shadow: rgba(0, 0, 0, 0.1);
    }

    /* body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-light);
      margin: 0;
      padding: 30px;
      color: var(--text-dark);
    }

    .feed-container {
      max-width: 680px;
      margin: auto;
    } */

    body {
        background-image: url('https://images.unsplash.com/photo-1503264116251-35a269479413?auto=format&fit=crop&w=1920&q=80');
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        position: relative;
        min-height: 100vh;
        font-family: 'Poppins', sans-serif;
    }

    body::before {
        content: "";
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,0.35);
        backdrop-filter: blur(6px);
        z-index: 0;
    }

    .feed-container {
        position: relative;
        z-index: 1;
        max-width: 700px;
        margin: 40px auto;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        padding: 24px;
    }


    /* ---------- HEADER ---------- */
    .feed-header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    h1 {
      color: var(--primary);
      font-size: 26px;
      margin: 0;
    }

    .user-info-top {
      background: var(--card-bg);
      padding: 8px 14px;
      border-radius: 25px;
      box-shadow: 0 2px 4px var(--shadow);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-info-top strong {
      color: var(--text-dark);
    }

    .logout-btn {
      background-color: var(--danger);
      border: none;
      color: #fff;
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      opacity: 0.9;
    }

    /* ---------- CREATE POST ---------- */
    .create-post-card {
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: 0 2px 5px var(--shadow);
      padding: 20px;
      margin-bottom: 25px;
      transition: all 0.3s ease;
    }

    .create-post-card:hover {
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
    }

    .create-post-card h2 {
      font-size: 18px;
      margin-bottom: 10px;
      color: var(--text-dark);
    }

    #post-text {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      resize: none;
      font-size: 15px;
      margin-bottom: 10px;
    }

    #post-text:focus {
      outline: 1px solid var(--primary);
    }

    #image-upload {
      margin-bottom: 10px;
    }

    #image-crop-area {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }

    .preview-image {
      width: 150px;
      height: 150px;
      border-radius: 8px;
      object-fit: cover;
      border: 1px solid var(--border);
    }

    .post-form-btn {
      width: 100%;
      background-color: var(--secondary);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 0;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .post-form-btn:hover {
      background-color: #36a420;
    }

    .post-form-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* ---------- FEED CARD ---------- */
    .feed-card {
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: 0 1px 4px var(--shadow);
      padding: 18px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }

    .feed-card:hover {
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .feed-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .user-info {
      font-weight: 600;
      color: var(--text-dark);
    }

    .timestamp {
      font-size: 12px;
      color: var(--text-muted);
      margin-left: 10px;
    }

    .report-btn {
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 14px;
      border-radius: 6px;
      padding: 5px 10px;
      transition: all 0.3s ease;
    }

    .report-btn:hover {
      background: #f1f3f4;
      color: var(--danger);
    }

    .feed-content {
      margin-bottom: 10px;
      font-size: 15px;
      line-height: 1.5;
    }

    /* ---------- IMAGES ---------- */
    .image-grid {
      display: grid;
      gap: 5px;
      margin-top: 10px;
      border-radius: 8px;
      overflow: hidden;
    }

    .image-grid img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .image-grid[data-count="1"] { grid-template-columns: 1fr; }
    .image-grid[data-count="2"] { grid-template-columns: repeat(2, 1fr); }
    .image-grid[data-count="3"] { grid-template-columns: 2fr 1fr; }
    .image-grid[data-count="4"] { grid-template-columns: repeat(2, 1fr); }

    .image-grid[data-count="3"] .img-item:first-child {
      grid-row: 1 / 3;
      height: 505px;
    }

    /* ---------- COMMENTS ---------- */
    .comment-section {
      border-top: 1px solid var(--border);
      padding-top: 10px;
      margin-top: 8px;
    }

    .comment-item {
      margin-bottom: 8px;
      padding: 6px 10px;
      background: #f7f7f7;
      border-radius: 6px;
    }

    .add-comment {
      display: flex;
      margin-top: 8px;
    }

    .add-comment input {
      flex: 1;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-right: 5px;
    }

    .add-comment button {
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      cursor: pointer;
      transition: 0.3s;
    }

    .add-comment button:hover {
      background-color: #0f6de0;
    }

    /* ---------- STATUS / LOADERS ---------- */
    .loading-message {
      text-align: center;
      color: var(--text-muted);
      padding: 20px;
    }

    /* Smooth fade-in animation */
    .feed-card {
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInUp 0.4s ease forwards;
    }

    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body>
  <div class="feed-container">

    <div class="feed-header-top">
      <h1>Social Feed</h1>
      <div class="user-info-top">
        <span>ðŸ‘¤ <strong>{{ current_username }}</strong></span>
        <a href="{% url 'logout' %}">
          <button class="logout-btn">Log Out</button>
        </a>
      </div>
    </div>

    <!-- Create Post -->
    <div class="feed-card create-post-card">
      <h2>Create New Post</h2>
      <textarea id="post-text" placeholder="What's happening?" rows="3"></textarea>
      <input type="file" id="image-upload" accept="image/*" multiple>
      <div id="image-crop-area"></div>
      <button id="post-submit" onclick="submitFeed()" class="post-form-btn" disabled>Post</button>
    </div>

    <!-- Feed Listing -->
    <div id="feed-listing"></div>

    <div class="loading-message" id="loading-spinner">Loading more feeds...</div>
    <div class="loading-message" id="end-of-feed" style="display: none;">You've reached the end!</div>
  </div>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Existing JS (unchanged except added reportFeed) -->
  <script>
    const CSRF_TOKEN = '{{ csrf_token }}';
    const API_BASE_URL = "/api/v1/feeds";
    let currentOffset = 0;
    const limit = 10;
    let isLoading = false;
    let imageFiles = [];

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          cookie = cookie.trim();
          if (cookie.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function formatTimestamp(isoString) {
      const date = new Date(isoString);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }

    function renderFeedCard(feed) {
      const imageCount = feed.images.length;
      let imageHtml = '';

      if (imageCount > 0) {
        imageHtml = `<div class="image-grid" data-count="${imageCount}">`;
        feed.images.forEach(img => {
          imageHtml += `<div class="img-item"><img src="${img.image}" alt="Post image"></div>`;
        });
        imageHtml += `</div>`;
      }

      let commentsHtml = `<div class="comment-section" id="comments-${feed.id}">`;
      feed.comments.forEach(comment => {
        commentsHtml += `
          <p class="comment-item">
            <strong>${comment.user.username}</strong>: ${comment.text_content}
            <span class="timestamp">(${formatTimestamp(comment.created_at)})</span>
          </p>`;
      });

      commentsHtml += `
        <div class="add-comment">
          <input type="text" id="comment-input-${feed.id}" placeholder="Write a comment...">
          <button onclick="postComment(${feed.id})">Comment</button>
        </div>
      </div>`;

      const feedCard = `
        <div class="feed-card" id="feed-${feed.id}">
          <div class="feed-header">
            <span class="user-info">${feed.user.username}</span>
            <div>
              <span class="timestamp">${formatTimestamp(feed.created_at)}</span>
              <button class="report-btn" onclick="reportFeed(${feed.id})">Report</button>
            </div>
          </div>
          <div class="feed-content">${feed.text_content || ''}${imageHtml}</div>
          ${commentsHtml}
        </div>`;

      $('#feed-listing').prepend(feedCard);
    }

    async function fetchFeeds() {
      if (isLoading) return;
      isLoading = true;
      $('#loading-spinner').show();

      try {
        const response = await fetch(`${API_BASE_URL}?offset=${currentOffset}&limit=${limit}`);
        if (response.status === 401) return (window.location.href = '/login/');
        const feeds = await response.json();
        if (feeds.length === 0) {
          $('#end-of-feed').show();
          $(window).off('scroll');
        } else {
          feeds.forEach(renderFeedCard);
          currentOffset += feeds.length;
        }
      } catch (error) {
        console.error("Feed fetch error:", error);
      } finally {
        isLoading = false;
        $('#loading-spinner').hide();
      }
    }

    async function postComment(feedId) {
      const input = $(`#comment-input-${feedId}`);
      const text_content = input.val().trim();
      if (!text_content) return;

      try {
        const response = await fetch(`${API_BASE_URL}/${feedId}/comments/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ text_content })
        });

        if (response.ok) {
          const comment = await response.json();
          const commentHtml = `<p class="comment-item"><strong>${comment.user.username}</strong>: ${comment.text_content} <span class="timestamp">(${formatTimestamp(comment.created_at)})</span></p>`;
          $(`#comments-${feedId} .add-comment`).before(commentHtml);
          input.val('');
        }
      } catch {
        alert("Error posting comment.");
      }
    }

    async function submitFeed() {
      const text_content = $('#post-text').val().trim();
      if (!text_content && imageFiles.length === 0) return alert("Post cannot be empty.");

      const formData = new FormData();
      formData.append('text_content', text_content);
      imageFiles.forEach(f => formData.append('images', f));

      try {
        const response = await fetch(`${API_BASE_URL}/`, {
          method: 'POST',
          headers: { 'X-CSRFToken': getCookie('csrftoken') },
          body: formData
        });

        if (response.ok) {
          const newFeed = await response.json();
          renderFeedCard(newFeed);
          $('#post-text').val('');
          $('#image-crop-area').html('');
          $('#image-upload').val('');
          imageFiles = [];
          $('#post-submit').prop('disabled', true);
        } else {
          alert("Feed creation failed.");
        }
      } catch (err) {
        console.error(err);
      }
    }

    async function reportFeed(feedId) {
      if (!confirm("Are you sure you want to report this post?")) return;

      try {
        const response = await fetch(`${API_BASE_URL}/${feedId}/report/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
        });
        const data = await response.json();

        if (response.ok) {
          alert(data.detail || "Feed reported successfully!");
          const btn = document.querySelector(`#feed-${feedId} .report-btn`);
          if (btn) {
            btn.textContent = "Reported";
            btn.disabled = true;
            btn.style.color = "gray";
            btn.style.cursor = "not-allowed";
          }
        } else {
          alert(data.detail || "Error while reporting feed.");
        }
      } catch (error) {
        alert("Something went wrong while reporting this feed.");
      }
    }

    $('#image-upload').on('change', function (e) {
      const files = e.target.files;
      if (!files.length) return;
      $('#image-crop-area').html('');
      imageFiles = Array.from(files).slice(0, 4);

      imageFiles.forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = $('<img>').attr('src', e.target.result).addClass('preview-image');
          $('#image-crop-area').append(img);
          $('#post-submit').prop('disabled', false);
        };
        reader.readAsDataURL(file);
      });
    });

    $('#post-text').on('input', function () {
      $('#post-submit').prop('disabled', !($(this).val().trim() || imageFiles.length));
    });

    function checkScroll() {
      if ($(window).scrollTop() + $(window).height() >= $(document).height() - 100) fetchFeeds();
    }

    $(document).ready(function () {
      fetchFeeds();
      $(window).on('scroll', checkScroll);
    });
  </script>
</body>
</html>
